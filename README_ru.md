# Сервис создания рассылок
Описание функцинальности: https://www.craft.do/s/n6OVYFVUpq0o6L <br>
Из дополнительного реализован Swagger UI, админка (в самом простом виде), чуть затронула логгирование<br>
<b>UPD:</b> добавила файлы для создания докера (запускается на localhost:8080) 

# Запуск
1. Установить зависимости из файла requirements.txt: pip install -r requirements.txt
2. Применить миграции: python manage.py migrate
3. Установить переменную окружения FBRQ_TOKEN (файл .env). Переменная содержит токен для аутентификаци на сервисе по отправке сообщений: https://probe.fbrq.cloud/docs 
4. После запуска сервера запустить автоматическое создание задач по отправке собщений из рассылки, если есть сообщения, ожидающие отправки (см. ниже) 

## Автоматическое создание задач
Так как celery не дружит с windows, то в качестве быстрого решения я использовала запуск crawler.py.<br>
**Для запуска автматическй проверки актуальных задач:**
1. Запустить сервер:  python manage.py runserver 127.0.0.1:8080
2. Запустить задачу: python manage.py runscript crawler

(Мжно также запустить через shell:
2. Зайти в django shell: python manage.py shell
3. Запустить crawler: import mailing_app.crawler)

**Идея**: Каждые 5 секунд проверяется есть ли на текущий момент сообщения в статусе pending (ожидающие отправки). 
- Проверяется время начала и окончания рассылки для pending сообщений. 
- Для pending cообщений, которые могут быть отправлены сейчас, создаются задачи отправки. 
- Неактуальные собщения (которые по каким-то причинам не были отправлены) перехдят в статус not-sent.
- Если сервер отправки вернул код 400, то сообщение переходит в статус not sent и больше не отправляется
- Если на сервере произошел сбой или возвращается другой код ошибки - задача остается в статусе pending (то есть сохраняет возможность на переотправку)


# Описание проекта
## Database model
База данных для этого проекта сстоит из трех таблиц:
* Mailing = рассылка
* Client = клиент
* Message = сообщение: 
        - имеет два foreign key для связи с рассылкой и клиентом <br>
        - статус может принимать три значения sent, not sent и pending

## Админка
Для быстрого добавления рассылок модели зарегистрированы в админке. <br>
Доступ к админке по /admin/

## API description
После запуска проекта документация по API будет доступна по api/v1/docs/ (Swagger UI)
- api/v1/clients  - получение списка клиентов и добавление нового
- api/v1/clients/<client_id> - получение информации о конкретном клиенте, изменение данных и удаление клиента

- api/v1/mailings  - получение списка всех рассылок (включает в себя информацию о количестве отправленных сообщений, сгруппированную по статусам сообщений)
- api/v1/mailings/<mailing_id> - получение информации о конкретной рассылке, изменение данных и удаление рассылки
- api/v1/mailings/<mailing_id>/stats - подробная статистика по сообщениям, созданным по конкретной рассылке

## Логирование
В некоторых модулях создан logger для выведения сообщений. Я использовала для отладки<br> 
Сейчас в настройках проекта логгер настроен на вывод в терминал 

## Тестирование 
(пока только для clients API)<br>
Использованы unit tests с использованием APITestCase и django TestCase.<br>
Для запуска: <br>
* API: python manage.py test tests.test_api
* serializers: python manage.py test tests.test_serializers




